# 小智AI语音聊天机器人项目综合框架文档

## 项目概述

小智AI语音聊天机器人项目是一个基于ESP32系列芯片的智能语音交互系统，支持多种通信协议和70多种开发板。项目集成了音频处理、显示屏控制、物联网设备管理等功能，通过先进的通信协议实现设备与云端服务的高效交互。

## 整体架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│                 │    │                  │    │                 │
│   AI服务器      │◄──►│   MCP协议层      │◄──►│   ESP32设备     │
│                 │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                       ┌──────────────────┐
                       │  通信协议层      │
                       │  (WebSocket/MQTT)│
                       └──────────────────┘
                                │
                       ┌──────────────────┐
                       │  音频数据传输    │
                       │  (UDP/Audio Stream)│
                       └──────────────────┘
```

## 1. 开发板支持与定制

### 1.1 支持范围
- 支持70多种ESP32系列开发板
- 每个开发板有唯一的标识和对应的固件升级通道
- 支持ESP32、ESP32S3、ESP32C3、ESP32C6、ESP32P4等多种芯片

### 1.2 开发板目录结构
```
boards/
├── [品牌名]-[开发板类型]/
│   ├── xxx_board.cc     # 板级初始化代码
│   ├── config.h         # 硬件管脚映射和配置项
│   ├── config.json      # 编译配置
│   └── README.md        # 开发板说明文档
```

### 1.3 配置文件说明
- **config.h**：定义音频采样率、I2S引脚、I2C引脚、按钮、LED、显示屏参数等
- **config.json**：定义目标芯片型号、构建配置、Flash大小等
- **Kconfig.projbuild**：添加开发板类型选项
- **CMakeLists.txt**：配置开发板特定参数

### 1.4 板级初始化类
- 继承自`WifiBoard`、`Ml307Board`或`DualNetworkBoard`
- 实现音频编解码器、显示屏、按钮等组件的初始化
- 通过`DECLARE_BOARD`宏注册开发板

## 2. 通信协议体系

### 2.1 WebSocket协议
- **用途**：主要通信通道，支持控制消息和音频数据传输
- **特点**：
  - 使用JSON格式传输控制消息
  - 二进制帧传输音频数据（Opus编码）
  - 支持多种协议版本（1/2/3）

- **握手流程**：
  1. 设备发送Hello消息，包含版本、功能、音频参数
  2. 服务器回复Hello，确认连接并提供会话ID
  3. 建立稳定通信通道

- **消息类型**：
  - **控制类**：hello、listen、abort、goodbye
  - **数据类**：stt、tts、llm、mcp、system、custom
  - **音频类**：二进制Opus音频数据

### 2.2 MQTT+UDP混合协议
- **架构**：双通道设计，MQTT控制+UDP音频
- **MQTT通道**：
  - 负责控制消息、状态同步、JSON数据交换
  - 包含认证、心跳、自动重连机制
- **UDP通道**：
  - 实时音频数据传输
  - AES-CTR加密保护
  - 序列号管理防重放攻击

### 2.3 协议选择策略
- **WebSocket**：适合一般网络环境，易于穿透防火墙
- **MQTT+UDP**：适合高实时性要求场景，但部署复杂度较高

## 3. MCP(Model Context Protocol)协议

### 3.1 协议定位
- 新一代物联网控制协议
- 基于标准JSON-RPC 2.0规范
- 通过`type: "mcp"`消息在各种传输协议上传输

### 3.2 核心功能
- **工具发现**：通过`tools/list`获取设备支持的功能
- **工具调用**：通过`tools/call`执行设备端功能
- **会话管理**：通过`initialize`初始化通信会话

### 3.3 工具注册机制
- 通过`McpServer::AddTool`注册可调用功能
- 支持参数类型：布尔、整数、字符串
- 推荐命名风格：`模块.功能`（如`self.light.set_rgb`）

### 3.4 交互流程
```
设备连接 → 协议会话初始化 → 获取工具列表 → 调用工具 → 结果返回
```

## 4. 音频处理系统

### 4.1 音频编解码
- **编码格式**：Opus
- **采样率**：设备端16000Hz，服务器端24000Hz
- **声道数**：单声道
- **帧时长**：默认60ms

### 4.2 音频流程
- **输入**：麦克风 → 预处理 → Opus编码 → 网络传输
- **输出**：网络接收 → Opus解码 → 重采样 → 扬声器播放

### 4.3 硬件支持
- 支持ES8311、ES7210等多种音频编解码芯片
- I2S接口配置
- PA功放控制

## 5. 显示与交互系统

### 5.1 显示屏支持
- **SPI显示屏**：ST7789、ILI9341等
- **QSPI显示屏**：SH8601等
- **配置参数**：分辨率、镜像、旋转、背光等

### 5.2 用户交互
- 按钮输入处理
- LED状态指示
- 屏幕UI反馈

### 5.3 表情与动画
- 支持Twemoji表情集
- LLM情感表达
- 动画效果渲染

## 6. 系统状态管理

### 6.1 设备状态流转
```
未知 → 启动 → WiFi配置/设备激活 → 固件升级 → 空闲 → 连接 → 监听/说话
```

### 6.2 会话管理
- Session ID跟踪
- 连接状态监控
- 自动重连机制

## 7. 安全与认证

### 7.1 认证机制
- WebSocket: Authorization Bearer Token
- MQTT: 用户名/密码认证
- UDP: 通过控制通道分发加密密钥

### 7.2 数据安全
- WebSocket: TLS/SSL加密
- UDP: AES-CTR加密
- 防重放攻击：序列号单调递增验证

## 8. 部署与运维

### 8.1 固件构建
- 支持`idf.py`手动配置
- 支持`scripts/release.py`自动构建
- 支持多平台交叉编译

### 8.2 运维监控
- 连接成功率统计
- 音频传输延迟监测
- 数据包丢失率统计
- 系统资源使用情况

## 9. 扩展与集成

### 9.1 物联网集成
- 通过MCP协议实现设备控制
- 支持多种传感器和执行器
- 统一的工具注册和调用接口

### 9.2 第三方服务
- AI大语言模型集成
- 语音识别与合成服务
- 远程OTA升级支持

## 10. 最佳实践

### 10.1 开发板定制
- 遵循目录结构规范
- 正确配置硬件参数
- 实现必要的接口方法

### 10.2 通信协议选择
- 优先使用WebSocket协议
- 对实时性要求极高的场景可考虑MQTT+UDP
- 合理使用MCP协议进行设备控制

### 10.3 安全考虑
- 正确实施认证机制
- 启用数据加密传输
- 定期更新固件和证书